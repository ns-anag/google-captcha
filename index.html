<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vue.js reCAPTCHA Enterprise</title>
    <!-- 1. Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. Load Vue.js (v3) -->
    <script src="https://unpkg.com/vue@3"></script>
    
    <!-- 3. Load Google reCAPTCHA Enterprise (v3) API -->
    <script 
        src="https://www.google.com/recaptcha/enterprise.js?render=6LfA2PUrAAAAAHpAiEqVIjx75by751WRkBxiyhRK&onload=onV3Load" 
        async 
        defer>
    </script>
    
    <!-- 4. Load Google reCAPTCHA v2 API (for the challenge) -->
    <!-- 'onload=onV2Load' and 'render=explicit' are key -->
    <script 
        src="https://www.google.com/recaptcha/api.js?onload=onV2Load&render=explicit" 
        async 
        defer>
    </script>
    
    <!-- 5. Load Lucide icons -->
    <script src="https://unpkg.com/lucide-vue-next"></script>
    
    <script>
      // Configure Tailwind to use Inter font
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', 'sans-serif'],
            },
          },
        },
      }
    </script>
    
    <style>
        /* Simple style for message boxes */
        .message {
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
            font-weight: 500;
            display: flex;
            align-items: center;
        }
        .message-success { background-color: #d1fae5; color: #065f46; border: 1px solid #a7f3d0; }
        .message-error { background-color: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
        .message-info { background-color: #dbeafe; color: #1e40af; border: 1px solid #bfdbfe; }
        
        /* Style for the raw JSON response */
        pre {
            background-color: #1f2937; /* Dark background */
            border: 1px solid #374151;
            border-radius: 0.5rem;
            padding: 1rem;
            overflow-x: auto; /* Horizontal scroll */
            overflow-y: auto; /* Vertical scroll */
            max-height: 70vh; /* Limit height to 70% of viewport height */
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
            font-size: 0.875rem;
            color: #d1d5db; /* Light text */
            margin-top: 0.5rem;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans antialiased">
    
    <div id="app" class="flex flex-col lg:flex-row items-center lg:items-start justify-center min-h-screen p-4 lg:p-8 gap-8">
        
        <!-- Login Card -->
        <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-2xl shadow-xl flex-shrink-0">
            <!-- Header -->
            <div class="flex flex-col items-center">
                <span class="p-3 bg-blue-100 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-600 lucide lucide-shield-check"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="m9 12 2 2 4-4"/></svg>
                </span>
                <h1 class="mt-4 text-2xl font-bold text-center text-gray-900">Login (reCAPTCHA Enterprise)</h1>
                <p class="text-sm text-center text-gray-600">This form is protected by Google reCAPTCHA.</p>
            </div>
            
            <!-- Login Form -->
            <form @submit.prevent="handleSubmit" class="space-y-6">
                
                <!-- Username Field -->
                <div>
                    <label for="username" class="block text-sm font-medium text-gray-700">Username</label>
                    <input 
                        v-model="username"
                        type="text" 
                        id="username"
                        class="w-full px-4 py-2 mt-1 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition duration-150"
                        placeholder="username"
                        required
                    >
                </div>
                
                <!-- Password Field -->
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                    <input 
                        v-model="password"
                        type="password" 
                        id="password"
                        class="w-full px-4 py-2 mt-1 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition duration-150"
                        placeholder="••••••••"
                        required
                    >
                </div>

                <!-- 
                  NEW: v2 Checkbox Challenge
                  This is hidden by default and only shows if 'challengeVisible' is true
                -->
                <div v-if="challengeVisible" class="flex justify-center">
                    <div id="v2-challenge-widget"></div>
                </div>
                
                <!-- Submit Button -->
                <div>
                    <button 
                        type="submit" 
                        :disabled="loading"
                        class="w-full flex justify-center px-4 py-2.5 font-medium text-white bg-blue-600 rounded-lg shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed transition duration-150"
                    >
                        <svg v-if="loading" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        {{ loading ? 'Verifying...' : 'Login' }}
                    </button>
                </div>
            </form>
            
            <!-- Message Area (stays inside the card) -->
            <div v-if="message" :class="['message', `message-${messageType}`]">
                <!-- Icons for messages -->
                <svg v-if="messageType === 'success'" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 lucide lucide-check-circle"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="m9 11 3 3L22 4"/></svg>
                <svg v-if="messageType === 'error'" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 lucide lucide-alert-triangle"><path d="m21.73 18-8-14a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>
                <svg v-if="messageType === 'info'" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 lucide lucide-info"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
                
                <span class="flex-1">{{ message }}</span>
            </div>
            
        </div>

        <!-- Raw Response Display -->
        <div v-if="rawResponse" class="w-full max-w-md lg:max-w-2xl">
            <h3 class="text-sm font-semibold text-gray-700">Raw Backend Response:</h3>
            <pre>{{ JSON.stringify(rawResponse, null, 2) }}</pre>
        </div>

    </div>

    <script>
        // Your reCAPTCHA Enterprise (v3) Site Key
        const ENTERPRISE_SITE_KEY = "6LfA2PUrAAAAAHpAiEqVIjx75by751WRkBxiyhRK";

        // !! ========================================================== !!
        // !! IMPORTANT: Add your new reCAPTCHA v2 (Checkbox) SITE KEY   !!
        // !! ========================================================== !!
        const V2_CHALLENGE_SITE_KEY = "6Ldo3fUrAAAAAAAYjyoy8oEVaT_CU8z41OMVigN0";
        // !! ========================================================== !!
        
        
        // We need to track that both APIs are loaded before mounting Vue
        let v3Loaded = false;
        let v2Loaded = false;

        const app = Vue.createApp({
            data() {
                return {
                    username: 'dummyuser',
                    password: 'dummypassword',
                    message: '',
                    messageType: 'info', // 'info', 'success', 'error'
                    loading: false,
                    rawResponse: null,
                    challengeVisible: false, // NEW: Controls the v2 checkbox
                    v2Token: null, // NEW: Stores the token from the v2 checkbox
                    v2WidgetId: null // NEW: Stores the ID of the rendered widget
                }
            },
            methods: {
                async handleSubmit() {
                    this.loading = true;
                    this.message = 'Verifying...';
                    this.messageType = 'info';

                    // Check if we are submitting a v2 token or a new v3 token
                    if (this.v2Token) {
                        // Logic for v2 (Challenge) verification
                        await this.handleV2Login();
                    } else {
                        // Logic for v3 (Invisible) verification
                        await this.handleV3Login();
                    }
                },
                
                async handleV3Login() {
                    if (typeof grecaptcha === 'undefined' || !grecaptcha.enterprise) {
                        this.message = 'Error: reCAPTCHA Enterprise script did not load.';
                        this.messageType = 'error';
                        this.loading = false;
                        return;
                    }

                    grecaptcha.enterprise.ready(async () => {
                        try {
                            const token = await grecaptcha.enterprise.execute(ENTERPRISE_SITE_KEY, { action: 'login' });
                            
                            const response = await fetch('/login-v3', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    username: this.username,
                                    password: this.password,
                                    token: token 
                                })
                            });

                            const data = await response.json();
                            this.rawResponse = data;

                            if (response.ok) {
                                // SUCCESS (High Score)
                                this.message = `${data.message} (Score: ${data.score})`;
                                this.messageType = 'success';
                                this.challengeVisible = false; // Hide challenge if it was open
                            } else if (response.status === 401 && data.challengeRequired) {
                                // LOW SCORE - Show Challenge
                                this.message = data.message;
                                this.messageType = 'info';
                                this.challengeVisible = true;
                                this.renderV2Challenge();
                            } else {
                                // Other error
                                throw new Error(data.message || 'An unknown error occurred.');
                            }

                        } catch (error) {
                            console.error('v3 Login failed:', error);
                            this.message = `Error: ${error.message}`;
                            this.messageType = 'error';
                            if (!this.rawResponse) { this.rawResponse = { error: error.message, success: false }; }
                        } finally {
                            this.loading = false;
                        }
                    });
                },

                async handleV2Login() {
                    try {
                        const response = await fetch('/login-v2', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                username: this.username,
                                password: this.password,
                                token: this.v2Token // Send the v2 token
                            })
                        });
                        
                        const data = await response.json();
                        this.rawResponse = data;
                        
                        if (response.ok) {
                            // SUCCESS (Challenge Passed)
                            this.message = `${data.message}`;
                            this.messageType = 'success';
                            this.challengeVisible = false; // Hide challenge
                        } else {
                            // Challenge failed
                            throw new Error(data.message || 'Challenge verification failed.');
                        }
                        
                    } catch (error) {
                        console.error('v2 Login failed:', error);
                        this.message = `Error: ${error.message}`;
                        this.messageType = 'error';
                    } finally {
                        this.loading = false;
                        // Reset v2 token so the next click is a v3 attempt
                        this.v2Token = null; 
                        if (this.v2WidgetId !== null) {
                            grecaptcha.reset(this.v2WidgetId);
                        }
                    }
                },
                
                // NEW: Renders the v2 checkbox
                renderV2Challenge() {
                    // Use nextTick to ensure the #v2-challenge-widget div exists in the DOM
                    this.$nextTick(() => {
                        if (document.getElementById('v2-challenge-widget') && this.v2WidgetId === null) {
                            try {
                                this.v2WidgetId = grecaptcha.render('v2-challenge-widget', {
                                    'sitekey': V2_CHALLENGE_SITE_KEY,
                                    'callback': this.onV2TokenCallback, // Method to call when checked
                                    'expired-callback': this.onV2TokenExpired
                                });
                            } catch (e) {
                                console.error("Error rendering v2 widget: ", e);
                                this.message = "Error: Could not load CAPTCHA challenge. Is the v2 Site Key correct?";
                                this.messageType = "error";
                            }
                        }
                    });
                },
                
                // NEW: Callback for when v2 checkbox is checked
                onV2TokenCallback(token) {
                    console.log("v2 token received:", token);
                    this.v2Token = token;
                    this.message = "Challenge complete. Click Login to proceed.";
                    this.messageType = "info";
                },
                
                // NEW: Callback for when v2 token expires
                onV2TokenExpired() {
                    this.v2Token = null;
                    this.message = "CAPTCHA expired. Please try again.";
                    this.messageType = "error";
                }
            }
        });
        
        // This mounts the Vue app *after* both APIs have loaded
        function attemptMount() {
            if (v3Loaded && v2Loaded) {
                console.log("Both reCAPTCHA v2 and v3 APIs loaded. Mounting Vue.");
                // We need to make Vue's methods available globally for v2 callback
                const vm = app.mount('#app');
                
                // Hack to make v2 callbacks work with Vue's scope
                // This is necessary because the v2 'grecaptcha.render' callback
                // is outside Vue's context.
                window.vueApp = vm;
                
                // We re-write the render function to use the globally exposed VM
                vm.renderV2Challenge = () => {
                    vm.$nextTick(() => {
                        if (document.getElementById('v2-challenge-widget') && vm.v2WidgetId === null) {
                             try {
                                vm.v2WidgetId = grecaptcha.render('v2-challenge-widget', {
                                    'sitekey': V2_CHALLENGE_SITE_KEY,
                                    'callback': (token) => window.vueApp.onV2TokenCallback(token),
                                    'expired-callback': () => window.vueApp.onV2TokenExpired()
                                });
                            } catch (e) {
                                console.error("Error rendering v2 widget: ", e);
                                vm.message = "Error: Could not load CAPTCHA challenge. Is the v2 Site Key correct?";
                                vm.messageType = "error";
                            }
                        }
                    });
                }
            }
        }

        // Global callbacks for API loads
        window.onV3Load = () => {
            console.log("reCAPTCHA Enterprise (v3) API loaded.");
            v3Loaded = true;
            attemptMount();
        };
        
        window.onV2Load = () => {
            console.log("reCAPTCHA v2 API loaded.");
            v2Loaded = true;
            attemptMount();
        };

    </script>
</body>
</html>
